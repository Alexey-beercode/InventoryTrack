<app-header
  title="–°–ø–∏—Å–∞–Ω–∏—è"
  (userEmitter)="onUserReceived($event!)"
></app-header>

<div class="writeoff-container">
  <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
  <div class="filter-container">
    <button
      *ngFor="let status of [RequestStatus.Requested, RequestStatus.Created, RequestStatus.Rejected]"
      (click)="onStatusChange(status)"
      [class.active]="filterStatus === status"
    >
      {{ status | enumLabel: 'RequestStatus' }}
    </button>
  </div>

  <!-- üÜï –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
  <div class="view-controls" *ngIf="!isLoading && writeOffRequests.length > 0 && hasBatchesToGroup()">
    <button class="view-toggle-btn" (click)="toggleGroupedView()">
      {{ showGroupedView ? 'üìã –°–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤' : 'üì¶ –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–∞—Ä—Ç–∏—è–º' }}
    </button>
  </div>

  <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
  <div *ngIf="isLoading" class="loading-container">
    <app-loading-spinner></app-loading-spinner>
  </div>

  <!-- –ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ -->
  <div *ngIf="!isLoading && writeOffRequests.length === 0">
    <p class="no-requests">–ó–∞—è–≤–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.</p>
  </div>

  <!-- üÜï –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∏–¥ (–ø–æ –ø–∞—Ä—Ç–∏—è–º) -->
  <div *ngIf="!isLoading && writeOffRequests.length > 0 && showGroupedView">
    <div *ngFor="let group of getBatchGroupsArray()" class="batch-group">

      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞—Ä—Ç–∏–∏ -->
      <div class="batch-header" *ngIf="group.isBatch">
        <div class="batch-info">
          <h3>üì¶ –°–ø–∏—Å–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏–∏: {{ group.batchNumber }}</h3>
          <div class="batch-summary">
            <span class="batch-stat">
              üìä –ó–∞–ø—Ä–æ—Å–æ–≤: {{ group.requests.length }}
            </span>
            <span class="batch-stat">
              üì¶ –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {{ getBatchSummary(group.requests).totalQuantity }}
            </span>
            <span class="batch-stat">
              üè™ –°–∫–ª–∞–¥–æ–≤: {{ getBatchSummary(group.requests).warehousesCount }}
            </span>
            <span class="batch-status" [ngClass]="'status-' + getBatchStatus(group.requests).status.toLowerCase()">
              üè∑Ô∏è {{ getBatchStatus(group.requests).status }}
            </span>
          </div>
        </div>
      </div>

      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ -->
      <div class="individual-header" *ngIf="!group.isBatch && group.batchNumber === 'individual'">
        <h3>üìÑ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å–ø–∏—Å–∞–Ω–∏—è</h3>
      </div>

      <!-- –ó–∞–ø—Ä–æ—Å—ã –≤ –≥—Ä—É–ø–ø–µ -->
      <div class="requests-in-group">
        <app-writeoff-actions
          *ngFor="let request of group.requests"
          [writeOffRequest]="request"
          [userId]="userId"
          [showBatchInfo]="group.isBatch"
          (reload)="loadWriteOffRequests()"
        ></app-writeoff-actions>
      </div>
    </div>
  </div>

  <!-- üÜï –û–±—ã—á–Ω—ã–π –≤–∏–¥ (—Å–ø–∏—Å–æ–∫) -->
  <div *ngIf="!isLoading && writeOffRequests.length > 0 && !showGroupedView">
    <app-writeoff-actions
      *ngFor="let request of writeOffRequests"
      [writeOffRequest]="request"
      [userId]="userId"
      [showBatchInfo]="true"
      (reload)="loadWriteOffRequests()"
    ></app-writeoff-actions>
  </div>
</div>

<app-footer></app-footer>
