<app-header
  title="–°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è"
  (companyIdEmitter)="onCompanyIdReceived($event)">
</app-header>

<div class="container">
  <app-back-button></app-back-button>

  <app-error-message *ngIf="errorMessage" [message]="errorMessage"></app-error-message>

  <form #writeOffForm="ngForm" (ngSubmit)="submitWriteOffRequest(writeOffForm)" class="writeoff-form" novalidate>

    <!-- –ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å -->
    <div class="form-group">
      <label for="item">–ú–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å</label>
      <select id="item" name="item" [(ngModel)]="selectedItemId" (ngModelChange)="updateMaxQuantity()" required #itemSelect="ngModel" class="form-control">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä</option>
        <option *ngFor="let item of items" [value]="item.id">
          {{ item.name }} ({{ item.quantity }} {{ item.measureUnit || '—à—Ç' }})
          <span *ngIf="item.batchNumber"> - –ü–∞—Ä—Ç–∏—è: {{ item.batchNumber }}</span>
        </option>
      </select>
      <div *ngIf="itemSelect.invalid && itemSelect.touched" class="error">‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä!</div>
    </div>

    <!-- üÜï –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è -->
    <div class="form-group" *ngIf="selectedItemId">
      <label>–†–µ–∂–∏–º —Å–ø–∏—Å–∞–Ω–∏—è</label>
      <div class="mode-selector">
        <button type="button"
                class="mode-btn"
                [class.active]="writeOffMode === 'individual'"
                (click)="switchWriteOffMode('individual')">
          üìÑ –£–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
        </button>
        <button type="button"
                class="mode-btn"
                [class.active]="writeOffMode === 'batch'"
                (click)="switchWriteOffMode('batch')">
          üì¶ –°–ø–∏—Å–∞—Ç—å –ø–∞—Ä—Ç–∏—é
        </button>
      </div>
    </div>

    <!-- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ -->
    <div class="form-group" *ngIf="writeOffMode === 'individual'">
      <label for="quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
      <input id="quantity" name="quantity" type="number" min="1" [max]="maxQuantity" [(ngModel)]="quantity" required #quantityInput="ngModel" class="form-control"/>
      <small>–î–æ—Å—Ç—É–ø–Ω–æ: {{ maxQuantity }} {{ getSelectedItemMeasureUnit() }}</small>
      <div *ngIf="quantityInput.invalid && quantityInput.touched" class="error">‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ!</div>
      <div *ngIf="quantity > maxQuantity" class="error">‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ!</div>
    </div>

    <!-- üÜï –í—ã–±–æ—Ä –ø–∞—Ä—Ç–∏–∏ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è -->
    <div class="batch-section" *ngIf="writeOffMode === 'batch'">

      <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä—Ç–∏–π -->
      <div class="form-group" *ngIf="!showBatchSelection">
        <button type="button" class="btn-load-batches" (click)="loadBatchesForItem()" [disabled]="isLoadingBatches">
          <span *ngIf="!isLoadingBatches">üì¶ –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–∞—Ä—Ç–∏–∏</span>
          <span *ngIf="isLoadingBatches">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞—Ä—Ç–∏–π...</span>
        </button>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–∏–π -->
      <div class="form-group" *ngIf="showBatchSelection && availableBatches.length > 0">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä—Ç–∏—é –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è</label>
        <div class="batches-list">
          <div *ngFor="let batch of availableBatches"
               class="batch-card"
               [class.selected]="selectedBatchNumber === batch.batchNumber"
               (click)="selectBatch(batch.batchNumber)">
            <div class="batch-header">
              <strong>üì¶ {{ batch.batchNumber }}</strong>
              <span class="batch-quantity">{{ batch.totalQuantity }} {{ getSelectedItemMeasureUnit() }}</span>
            </div>
            <div class="batch-details">
              <small>–ü–æ—Å—Ç–∞–≤—â–∏–∫: {{ batch.manufacturerName || '–ù–µ —É–∫–∞–∑–∞–Ω' }}</small>
              <small>–°—Ä–æ–∫ –≥–æ–¥–Ω–æ—Å—Ç–∏: {{ batch.expirationDate | date: 'dd.MM.yyyy' }}</small>
              <small>–¢–æ–≤–∞—Ä–æ–≤ –≤ –ø–∞—Ä—Ç–∏–∏: {{ batch.itemsCount }}</small>
            </div>
          </div>
        </div>
      </div>

      <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø–∞—Ä—Ç–∏–∏ -->
      <div class="selected-batch-info" *ngIf="selectedBatchNumber">
        <div class="alert alert-info">
          <strong>‚úÖ –í—ã–±—Ä–∞–Ω–∞ –ø–∞—Ä—Ç–∏—è: {{ selectedBatchNumber }}</strong>
          <p>–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ {{ getSelectedBatchItemsCount() }} –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å–ø–∏—Å–∞–Ω–∏–µ</p>
          <p>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {{ getSelectedBatchTotalQuantity() }} {{ getSelectedItemMeasureUnit() }}</p>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è -->
    <div class="form-group">
      <label for="reason">–ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è</label>
      <select id="reason" name="reason" [(ngModel)]="selectedReasonId" required #reasonSelect="ngModel" class="form-control">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É</option>
        <option *ngFor="let reason of writeOffReasons" [value]="reason.id">{{ reason.reason }}</option>
        <option value="other">–î—Ä—É–≥–æ–µ...</option>
      </select>
      <div *ngIf="reasonSelect.invalid && reasonSelect.touched" class="error">‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Å–ø–∏—Å–∞–Ω–∏—è!</div>
    </div>

    <!-- –î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ "–î—Ä—É–≥–æ–µ") -->
    <div class="form-group" *ngIf="selectedReasonId === 'other'">
      <label for="anotherReason">–î—Ä—É–≥–∞—è –ø—Ä–∏—á–∏–Ω–∞</label>
      <input id="anotherReason" name="anotherReason" type="text" [(ngModel)]="anotherReason" required #anotherReasonInput="ngModel" class="form-control"/>
      <div *ngIf="anotherReasonInput.invalid && anotherReasonInput.touched" class="error">‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Å–ø–∏—Å–∞–Ω–∏—è!</div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="button-group">
      <button type="submit"
              class="btn-primary"
              [disabled]="!canSubmit()">
        {{ writeOffMode === 'batch' ? 'üì¶ –°–ø–∏—Å–∞—Ç—å –ø–∞—Ä—Ç–∏—é' : 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å' }}
      </button>
      <button type="button" class="btn-secondary" (click)="cancel()">‚ùå –û—Ç–º–µ–Ω–∞</button>
    </div>

  </form>
</div>

<app-footer></app-footer>
